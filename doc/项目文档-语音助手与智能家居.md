# 语音助手与智能家居 — 项目文档

> 基于 `voice-assistant-api` 与 ESP32 的端到端语音对话与设备控制方案

---

## 一、项目概述

本项目实现「**语音输入 → 识别 → 大模型回复 → 语音合成 → 播放**」的完整链路，并支持通过自然语言控制智能家居设备（如开灯/关灯）。后端为 Spring Boot 服务（`voice-assistant-api`），可切换**本地部署**（PaddleSpeech + vLLM + Ollama）或**线上阿里云**（DashScope ASR/LLM/TTS）；终端可为 ESP32（麦克风录音上传、喇叭播放 TTS）或 Web/客户端。

### 端到端流程图

```
┌─────────────┐    ① 上传音频      ┌──────────────────┐    ② ASR       ┌─────────────────┐
│   ESP32     │ ─────────────────→ │  Spring Boot     │ ─────────────→ │  PaddleSpeech   │
│ 麦克风采集   │   (HTTP POST       │  后端服务         │   (调用 ASR)   │  ASR (语音→文字) │
│ 录音并上传   │    multipart)     │                  │ ←───────────── │                 │
└─────────────┘                    │                  │    文字        └─────────────────┘
       ↑                           │     ③ 请求大模型  │
       │                           │ ───────────────→ │  DeepSeek-R1(vLLM)
       │                           │ ←─────────────── │
       │                           │    ④ TTS        │  PaddleSpeech TTS
       │                           │ ───────────────→ │
       │     ⑤ 返回 audioUrl       │                  │
       │ ←─────────────────────────┘
       ▼     ⑥ HTTP GET 下载 → I2S → MAX98357A → 喇叭播放
┌─────────────┐
│   ESP32     │
└─────────────┘
```

设备控制：用户说「开灯/关客厅灯」→ 大模型解析并输出 `[DEVICE_CTL] room=客厅 action=on` → 后端查库向设备发 GET/POST → 该行从回复中移除，剩余内容做 TTS 播报。

---

## 二、项目结构（voice-assistant-api）

```
voice-assistant-api/
├── pom.xml
├── src/main/
│   ├── java/com/wshg/voice/
│   │   ├── VoiceAssistantApplication.java     # 启动类
│   │   ├── config/
│   │   │   ├── VoiceProperties.java           # 语音/本地-线上配置
│   │   │   └── VectorStoreConfig.java         # 向量库(MySQL/文件)配置
│   │   ├── controller/
│   │   │   ├── VoiceUploadController.java     # 语音上传、TTS、千问/本地管道
│   │   │   ├── TtsResourceController.java     # GET /tts/{filename} 音频下载
│   │   │   ├── DeviceController.java          # 设备 CRUD + 手动控制
│   │   │   └── VectorController.java          # 向量库：入库、检索、同步设备
│   │   ├── service/
│   │   │   ├── VoicePipelineService.java      # 管道：ASR→LLM→设备控制→TTS
│   │   │   ├── VectorStoreService.java        # 向量存储与 RAG 上下文
│   │   │   ├── EmbeddingService.java          # Ollama/DashScope Embedding
│   │   │   ├── DeviceControlService.java      # 解析 [DEVICE_CTL] 并下发设备
│   │   │   └── DeviceToVectorHelper.java      # 设备表 → 知识库文档
│   │   ├── store/、repository/、entity/、dto/
│   └── resources/
│       ├── application.yml
│       └── data.sql
```

### 模块职责

| 模块 | 职责 |
|------|------|
| **VoiceUploadController** | `/api/voice/upload`、`/api/voice/tts`、`/api/voice/qwen`、`/api/voice/qwen-asr-upload` |
| **TtsResourceController** | `GET /tts/{filename}`，供 ESP32 下载 WAV/MP3 |
| **VoicePipelineService** | ASR→LLM→设备控制→TTS，返回 text/reply/audioUrl |
| **DeviceControlService** | 解析 `[DEVICE_CTL] room=xx action=on/off`，查库并下发 HTTP |
| **VectorController** | 向量文档增删查、语义检索、设备表同步到知识库 |

---

## 三、主要作用

1. **语音管道**：WAV 上传 → ASR → 大模型（含 RAG）→ 设备控制（若有）→ TTS → 返回 text/reply/audioUrl。
2. **双模式**：**local**（PaddleSpeech + vLLM + Ollama）或 **online**（阿里云 DashScope）。
3. **RAG**：向量库存储知识，检索拼入 prompt；设备增删改可自动同步到向量库。
4. **智能家居**：设备表存 connection_url、control_on/off、room；大模型输出 `[DEVICE_CTL]` 行后下发。
5. **TTS 下载**：`GET /tts/{filename}` 提供音频，ESP32 用 audioUrl 拉取播放。

---

## 四、接口说明与调用示例

### 4.1 语音管道

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/voice/health` | 健康检查 |
| POST | `/api/voice/upload` | 上传 WAV（multipart 字段 `file`），返回 text/reply/audioUrl |

```bash
curl -X POST http://localhost:8080/api/voice/upload -F "file=@recording.wav"
```

响应：`{ "text": "识别文字", "reply": "大模型回复", "audioUrl": "http://.../tts/xxx.wav" }`

### 4.2 TTS

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/api/voice/tts` | Body: `{ "text": "要合成的文字" }` |
| GET | `/api/voice/tts?text=xxx` | 同上 |

### 4.3 千问（线上）

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/voice/qwen?text=用户输入` | 文本→千问 LLM→TTS→返回 text+audioUrl |
| POST | `/api/voice/qwen-asr-upload` | multipart `file`（WAV/MP3）→ Qwen3-ASR-Flash → 再走 qwen 流程 |

### 4.4 TTS 音频下载

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/tts/{filename}` | 返回音频流，ESP32 用 audioUrl 直接 GET |

### 4.5 智能家居设备

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/device/list?room=客厅` | 设备列表 |
| GET | `/api/device/{id}` | 设备详情 |
| POST | `/api/device` | 新增设备 |
| PUT | `/api/device/{id}` | 更新设备 |
| DELETE | `/api/device/{id}` | 删除设备 |
| POST | `/api/device/control` | 手动控制，Body: `{"room":"客厅","action":"on"}` 或 `{"deviceId":"device_001","action":"off"}` |

```powershell
# 新增设备
$body = @{
  deviceId="device_001"; deviceName="客厅主灯"; room="客厅"; roomId="living_room"
  deviceType="light"; connectionUrl="http://192.168.1.100:8080"; controlMethod="POST"
  controlOn='{"action":"on"}'; controlOff='{"action":"off"}'; enabled=$true
} | ConvertTo-Json
Invoke-RestMethod -Uri "http://localhost:8080/api/device" -Method Post -ContentType "application/json" -Body $body
```

### 4.6 向量库（RAG）

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/api/vector/documents` | 单条入库，Body: `{ "text": "文档内容" }` |
| POST | `/api/vector/documents/batch` | 批量入库，Body: `{ "texts": ["文档1","文档2"] }` |
| GET | `/api/vector/search?query=xxx&topK=5` | 语义检索 |
| GET | `/api/vector/stats` | 向量条数 |
| POST | `/api/vector/clear` | 清空向量库 |
| POST | `/api/vector/sync-from-devices` | 将设备表同步到知识库 |

---

## 五、本地部署详情

### 5.1 服务与端口

| 组件 | 部署方式 | 端口 | 说明 |
|------|----------|------|------|
| MySQL | 本机 | 3306 | 设备表、向量库表 |
| vLLM | WSL2 + Ubuntu | 8000 | 大模型 DeepSeek-R1-Distill-Qwen-7B |
| Ollama | Windows | 11434 | Embedding qwen3-embedding |
| PaddleSpeech | 本机 Python | 命令行 | 由 voice-assistant-api 调 paddlespeech |
| voice-assistant-api | Spring Boot | 8080 | `spring.profiles.active=local` |

### 5.2 MySQL

```sql
CREATE DATABASE voice_assistant CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

`application.yml` 配置 `spring.datasource`；`ddl-auto: update` 自动建表 `smart_home_device`、`vector_document`。

### 5.3 PaddleSpeech（ASR + TTS）

**环境**：Python >= 3.8，建议 3.9；内存 8GB+；磁盘 5GB+。

**安装：**

```bash
# 虚拟环境（可选）
conda create -n paddlespeech python=3.9 && conda activate paddlespeech

# PaddlePaddle（CPU）
pip install paddlepaddle -i https://mirror.baidu.com/pypi/simple

# PaddleSpeech
pip install paddlespeech -i https://pypi.tuna.tsinghua.edu.cn/simple
```

首次运行 ASR/TTS 会自动下载模型。

**ASR 命令行：** `paddlespeech asr --lang zh --input file.wav`（需 16kHz、16bit、单声道 WAV）

**TTS 命令行：** `paddlespeech tts --input "文字" --output output.wav`（默认约 24kHz）

**voice-assistant-api 配置：** `voice.paddlespeech-cmd: paddlespeech`。若命令不在 PATH，改为绝对路径，如 `"C:/Python311/Scripts/paddlespeech"`。

### 5.4 vLLM（DeepSeek-R1-Distill-Qwen-7B）

**前提**：Windows 10/11；NVIDIA GPU（建议显存 ≥16GB）；已装 NVIDIA 驱动。

**安装 WSL2 + Ubuntu：** 管理员 PowerShell 执行 `wsl --install -d Ubuntu-22.04`，按提示重启。

**Ubuntu 内安装 vLLM：**

```bash
sudo apt update && sudo apt install -y python3.10-venv git
python3 -m venv vllm-venv && source vllm-venv/bin/activate
pip install --upgrade pip && pip install "vllm[all]" huggingface_hub
```

**启动大模型：**

```bash
python -m vllm.entrypoints.openai.api_server \
  --model deepseek-ai/DeepSeek-R1-Distill-Qwen-7B \
  --trust-remote-code --host 0.0.0.0 --port 8000
```

看到 `Uvicorn running on http://0.0.0.0:8000` 即就绪。首次会下载模型，需较长时间。

**GPU 检查：** Ubuntu 中执行 `nvidia-smi` 可查看显卡与驱动。

### 5.5 Ollama（qwen3-embedding）

- 安装：https://ollama.com/download 下载 Windows 安装包
- 拉取模型：`ollama pull qwen3-embedding`
- 验证：`curl -X POST http://localhost:11434/api/embed -H "Content-Type: application/json" -d "{\"model\":\"qwen3-embedding\",\"input\":\"你好\"}"`

**Ollama Embedding 模型选型：**

| 模型 | 大小 | 维度 |
|------|------|------|
| nomic-embed-text | ~274MB | 768 |
| qwen3-embedding | ~400MB | 1024 |
| all-minilm | ~23MB | 384 |

### 5.6 voice-assistant-api 本地配置示例

```yaml
spring:
  profiles:
    active: local
  datasource:
    url: jdbc:mysql://localhost:3306/voice_assistant?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
    username: root
    password: 你的密码

voice:
  paddlespeech-cmd: paddlespeech
  vllm-base-url: http://localhost:8000
  vllm-model: deepseek-ai/DeepSeek-R1-Distill-Qwen-7B
  ollama-base-url: http://localhost:11434
  ollama-embedding-model: qwen3-embedding
  rag-enabled: true
  rag-top-k: 5
  rag-min-score: 0.5
  vector-store-type: mysql
```

### 5.7 启动顺序

1. 启动 MySQL
2. 启动 Ollama（安装后常驻）
3. WSL2 Ubuntu 启动 vLLM（保持终端不关）
4. 确保 PaddleSpeech 可用（`paddlespeech asr --help`）
5. 启动 voice-assistant-api：`mvn spring-boot:run`

### 5.8 常见问题（本地部署）

| 现象 | 处理 |
|------|------|
| vLLM `CUDA out of memory` | 换小模型或加 `--gpu-memory-utilization 0.8` |
| localhost:8000 连不上 | 确认 vLLM 启动时 `--host 0.0.0.0`，检查防火墙 |
| PaddleSpeech 安装报错 | Linux 装 `build-essential`；Windows 可试预编译包 |
| 中文 ASR 不准 | 确认音频 16kHz、16bit、单声道 WAV |
| Ollama embedding 失败 | 确认 Ollama 运行，执行 `ollama pull qwen3-embedding` |

---

## 六、ESP32 硬件配置详情

### 6.1 整体架构（I2S 播放）

```
服务器 TTS 提供 URL → ESP32 HTTP GET 下载 MP3/WAV
  → MP3 解码（libhelix/minimp3）→ PCM
  → I2S 输出 → MAX98357A → 喇叭
```

**I2S**：Inter-IC Sound，数字音频接口。PCM 为未压缩采样，MP3 需先解码为 PCM 再送 I2S。

### 6.2 接线（MAX98357A）

| MAX98357A 引脚 | 接 ESP32 | 说明 |
|----------------|----------|------|
| VIN | 3.3V 或 5V | 5V 音量更大，GND 需共地 |
| GND | GND | |
| DIN | GPIO25 | I2S 数据 |
| BCLK | GPIO26 | 位时钟 |
| LRC | GPIO22 | 左右声道时钟（WS） |
| OUT+ / OUT- | 喇叭 | 喇叭不接 ESP32 |

接线示意：

```
ESP32                MAX98357A              喇叭
3.3V/5V ──────────── VIN
GND ──────────────── GND
GPIO25 ───────────── DIN
GPIO26 ───────────── BCLK
GPIO22 ───────────── LRC
                      OUT+ / OUT- ───────── 喇叭
```

不同开发板 I2S 引脚可能不同，可软件映射到其它 GPIO。

### 6.3 麦克风（录音上传）

- 推荐 **INMP441**（I2S 数字麦克风）：SCK/WS/SD 接 ESP32 I2S 时钟、WS、数据输入（可与 MAX98357A 共用 BCLK/LRC）。
- 录音格式：16kHz、16bit、单声道 WAV，加 44 字节 WAV 头后上传。
- 上传：`esp_http_client` POST 到 `http://后端IP:8080/api/voice/upload`，body 为 multipart/form-data，字段名 `file`。

### 6.4 软件流程（播放）

1. NVS/WiFi 连接
2. I2S 驱动配置（输出、采样率 44100 或 16000、16bit、单声道）
3. HTTP GET audioUrl 拉取 MP3
4. 环形缓冲 → MP3 解码 → PCM 写 I2S

**关键参数：** 采样率与 TTS 一致（16kHz 或 24kHz）；位深 16bit；单声道。

**ESP-IDF 依赖：** `esp_http_client`、`driver/i2s`、libhelix 或 minimp3。

**Arduino 方案：** 可用 ESP32-audioI2S 等库，调用 `connecttohost("http://...")` 播放 URL，快速验证。

### 6.5 跨网访问（ESP32 与后端不在同一局域网）

| 方式 | 说明 |
|------|------|
| 内网穿透 | cpolar、花生壳、ngrok 等，映射后端端口到公网 URL |
| 端口映射 | 有公网 IP 时，路由器将外网端口转发到后端 |
| 云服务器 | 后端部署到云主机，ESP32 访问公网 IP |
| VPN | ZeroTier、Tailscale 等，ESP32 与后端同虚拟网 |

---

## 七、数据库与表结构

### 7.1 库与表

- 建库：`CREATE DATABASE voice_assistant CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;`
- `smart_home_device`：由 JPA `ddl-auto: update` 自动创建

| 字段 | 说明 |
|------|------|
| id | 主键 |
| device_id | 设备唯一标识 |
| device_name | 如「客厅主灯」 |
| room | 房间名，如「客厅」「卧室」 |
| room_id | 如 living_room |
| device_type | light / socket 等 |
| connection_url | 控制接口 base URL |
| control_method | GET / POST |
| control_on / control_off | 开/关指令（GET 为路径，POST 为 JSON） |
| status | on / off / unknown |
| enabled | 是否启用 |

- `vector_document`：id, text, embedding_json, metadata_json, source, created_at。向量维度与 Embedding 模型一致（qwen3-embedding 为 1024）。

### 7.2 设备控制流程

1. 用户说「开灯」「关客厅灯」等，ASR 转文字
2. 大模型结合 RAG 生成回复；若为开关灯意图，在回复**单独一行**输出：`[DEVICE_CTL] room=客厅 action=on` 或 `action=off`，未指定房间则 `room=all`
3. 管道解析该行 → 查 `smart_home_device` → 向匹配设备发 GET/POST
4. 该行从回复中移除，剩余内容做 TTS 播报

### 7.3 知识库与 RAG

- `voice.vector-store-type: mysql`（默认），所有文档存 MySQL `vector_document`
- 设备增删改后会自动调用同步，将设备信息写入知识库（`source=device`）；也可手动 `POST /api/vector/sync-from-devices`
- RAG 系统提示：严格根据知识库作答，不编造；无相关内容时明确说「不知道」

---

## 八、向量库与回答规范

**约束大模型不编造**：`VoicePipelineService.buildMessagesWithRag` 中，存在 RAG 上下文时，系统提示会要求严格按知识库回答。可在向量库中再加「回答规范」文档强化约束。

**API 插入（推荐）：** 服务端自动计算 embedding

```bash
curl -X POST http://localhost:8080/api/vector/documents \
  -H "Content-Type: application/json" \
  -d "{\"text\": \"回答规范：仅根据用户问题和命中的知识库资料作答，不要编造。无相关内容时明确说不知道。\"}"
```

**批量插入：** `POST /api/vector/documents/batch`，Body: `{ "texts": ["文档1", "文档2"] }`

**MySQL 直接插入**：需手写 embedding_json，维度需与模型一致；推荐用 API 插入。

**切换 Embedding 模型**：如从 DashScope 换 Ollama，向量维度可能变，建议 `POST /api/vector/clear` 后重新入库。

---

## 九、灯光控制与 AI 指令流程

### 9.1 方案选型

| 方案 | 通信方式 | 适用场景 |
|------|----------|----------|
| Arduino + USB 串口 | 电脑 USB 连接 | 学习、桌面 |
| ESP8266/ESP32 + WiFi | HTTP / MQTT | 远程、智能家居 |

### 9.2 串口协议（Arduino）

| 指令 | 含义 |
|------|------|
| LIGHT_ON | 开灯 |
| LIGHT_OFF | 关灯 |
| LIGHT_TOGGLE | 切换 |
| STATUS | 查询状态 |

### 9.3 HTTP 方式（ESP32）

设备建 Web 服务器，收到 `GET /light?action=off` 即关灯。AI 输出 `LIGHT_OFF` 后，程序请求 `http://ESP_IP/light?action=off`。

### 9.4 MQTT 方式

设备订阅 `home/light/cmd`，收到 `off` 即关灯；执行后向 `home/light/status` 发布状态。AI 生成 `off` 后，用 paho-mqtt 向 `home/light/cmd` 发布。

### 9.5 AI 提示词示例（灯光控制）

```
你是一个家居控制助手。
- 用户说「开灯」「打开灯」等 → 输出唯一一行：LIGHT_ON
- 用户说「关灯」「把灯关掉」等 → 输出唯一一行：LIGHT_OFF
- 用户说「切换」等 → 输出：LIGHT_TOGGLE
- 用户说「灯的状态」等 → 输出：STATUS
- 其他对话正常回答，不输出上述指令。
```

### 9.6 低压 LED 接线

```
Arduino Pin 13 ──[220Ω]── LED 正极
Arduino GND   ─────────── LED 负极
```

### 9.7 继电器控制 220V 灯（务必断电操作）

```
Arduino 5V/GND ── 继电器 VCC/GND
Arduino Pin 7  ── 继电器 IN
220V ──[继电器常开]── 灯泡 ── 零线
```

⚠️ 220V 接线需由具备电工资质的人员完成。

---

## 十、端到端实现顺序建议

1. **后端串联（无 ESP32）**：用 Postman 上传 16kHz WAV，Spring Boot 完成 ASR→vLLM→TTS→返回 audioUrl，浏览器播放。
2. **ESP32 仅播放**：后端固定返回测试 audioUrl，ESP32 做 HTTP GET + I2S 播放。
3. **ESP32 录音与上传**：接 I2S 麦克风，实现 16kHz WAV 录音与 POST 上传。
4. **全链路**：ESP32 上传 → 后端 ASR → 大模型 → TTS → 返回 audioUrl → ESP32 下载播放。

---

## 十一、硬件清单

### 11.1 语音播放与录音（ESP32）

| 序号 | 名称 | 规格 | 数量 | 用途 |
|------|------|------|------|------|
| 1 | ESP32 开发板 | 带 WiFi | 1 | 主控 |
| 2 | I2S 功放 | MAX98357A 或 UDA1334A | 1 | 驱动喇叭 |
| 3 | 喇叭 | 4Ω/8Ω，0.5W~3W | 1 | 接功放 OUT+/OUT- |
| 4 | I2S 麦克风 | INMP441 | 1 | 录音 |
| 5 | 杜邦线 | 公对母 | 若干 | 接线 |
| 6 | USB 线 | 供电/烧录 | 1 | |

### 11.2 灯光控制

| 序号 | 名称 | 规格 | 数量 |
|------|------|------|------|
| 1 | ESP32/ESP8266 或 Arduino | - | 1 |
| 2 | 继电器模块 | 5V 单路（带光耦） | 1 |
| 3 | 杜邦线 | - | 若干 |

低压演示：LED + 限流电阻 220Ω~330Ω 即可。

**采购关键词**：MAX98357A、I2S 功放模块、小喇叭 4欧 1W、杜邦线 公对母。

---

## 十二、软件清单

| 软件 | 版本/说明 | 用途 |
|------|-----------|------|
| JDK | 17 | voice-assistant-api |
| Maven | 3.x | 构建 |
| MySQL | 5.7+ / 8.x | 设备表、向量库 |
| Python | 3.8+ | PaddleSpeech |
| PaddlePaddle | 见安装步骤 | PaddleSpeech 依赖 |
| PaddleSpeech | pip/conda | ASR、TTS |
| vLLM | pip | 大模型推理（WSL2） |
| Ollama | 最新 | Embedding |
| ESP-IDF 或 Arduino | - | ESP32 开发 |
| libhelix 或 minimp3 | - | MP3 解码 |

---

*文档版本：1.1 | 不引用其他文档，内容集中整理*
