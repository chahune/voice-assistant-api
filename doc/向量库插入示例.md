# 向量库插入示例

## 一、让大模型「不胡说、严格按知识库回答」

已做两处设置：

1. **系统提示（推荐）**  
   在 `VoicePipelineService.buildMessagesWithRag` 中，当存在 RAG 上下文时，系统提示已改为：
   - 严格根据【知识库】和用户问题作答；
   - 仅使用知识库已有信息，不编造、不猜测；
   - 若知识库无相关内容，明确回答「根据当前知识库暂无相关内容」或「不知道」。

2. **向量库中可再加一条「回答规范」文档**  
   下面用 API 插入一条规范说明，语义检索时若命中可进一步强化约束（主要仍靠上面系统提示）。

---

## 二、向量库插入方式

### 方式一：API 插入（推荐）

插入时由服务端自动计算 embedding，无需手写向量。

**单条插入**：`POST /api/vector/documents`

```bash
curl -X POST http://localhost:8080/api/vector/documents \
  -H "Content-Type: application/json" \
  -d "{\"text\": \"回答规范：仅根据用户问题和命中的知识库资料作答，不要编造、不要猜测。若知识库中无与问题相关的内容，请明确说「根据当前知识库暂无相关内容」或「不知道」，不要胡说八道。\"}"
```

或插入一条更易被检索到的「回答要求」说明：

```bash
curl -X POST http://localhost:8080/api/vector/documents \
  -H "Content-Type: application/json" \
  -d "{\"text\": \"回答要求：大模型必须严格按照用户问题和命中的向量资料回答，不得胡说八道，不得编造知识库没有的内容。无相关内容时明确回答不知道。\"}"
```

**PowerShell 示例**：

```powershell
$body = @{ text = "回答规范：仅根据用户问题和命中的知识库资料作答，不要编造。无相关内容时明确说不知道。" } | ConvertTo-Json -Compress
Invoke-RestMethod -Method Post -Uri "http://localhost:8080/api/vector/documents" -ContentType "application/json" -Body ([System.Text.Encoding]::UTF8.GetBytes($body))
```

**批量插入**：`POST /api/vector/documents/batch`

```bash
curl -X POST http://localhost:8080/api/vector/documents/batch \
  -H "Content-Type: application/json" \
  -d "{\"texts\": [\"回答规范：仅根据用户问题和命中的知识库资料作答，不要编造。无相关内容时明确说不知道。\", \"其他你想入库的文档内容...\"]}"
```

---

### 方式二：MySQL 插入语句

#### 1. 知识库表 `vector_document`

**说明**：`embedding_json` 为向量 JSON 数组，维度需与配置一致（线上 1024、本地以 Ollama 模型为准）。**推荐用 API 插入**以自动计算向量；以下 SQL 中 `embedding_json` 使用占位向量，仅能入库，检索效果差，正式使用请用 `POST /api/vector/documents`。

```sql
-- 插入一条「回答规范」文档（embedding 为占位，建议用 API 插入获取真实向量）
INSERT INTO vector_document (id, text, embedding_json, metadata_json, source, created_at)
VALUES (
  'rag_rule_001',
  '回答规范：仅根据用户问题和命中的知识库资料作答，不要编造、不要猜测。若知识库中无与问题相关的内容，请明确说「根据当前知识库暂无相关内容」或「不知道」，不要胡说八道。',
  CONCAT('[', REPEAT('0.0,', 1023), '0.0]'),   /* 1024 维占位，与线上 embedding-dimensions 一致 */
  NULL,
  'manual',
  NOW()
);
```

若为本地 Ollama 模型（如 768 维），将 `REPEAT('0.0,', 1023)` 改为 `REPEAT('0.0,', 767)`。

#### 2. 智能家居设备表 `smart_home_device`

```sql
INSERT INTO smart_home_device (
  device_id, device_name, room, room_id, device_type,
  connection_url, control_method, control_on, control_off,
  status, enabled, created_at, updated_at
) VALUES (
  'esp32_living_001',
  '客厅主灯',
  '客厅',
  'living_room',
  'light',
  'http://192.168.1.100',
  'GET',
  '/on',
  '/off',
  'off',
  1,
  NOW(),
  NOW()
);
```

按需修改 `connection_url`（设备 IP）、`room`、`device_id` 等。

---

## 三、小结

| 目的               | 做法 |
|--------------------|------|
| 约束大模型不编造   | 已改系统提示，每次带 RAG 时都会生效 |
| 向量库中加规范说明 | 用 `POST /api/vector/documents` 插入上面「回答规范」文本即可 |
