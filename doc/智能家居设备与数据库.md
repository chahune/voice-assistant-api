# 智能家居设备与数据库

## 一、数据库与表

- **数据库**：MySQL。在 MySQL 中先创建库：`CREATE DATABASE voice_assistant CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;`
- **连接配置**：`application.yml` 中 `spring.datasource.url`、`username`、`password` 按本机 MySQL 修改（默认 url：`jdbc:mysql://localhost:3306/voice_assistant?...`，用户名 `root`，密码需填写）。
- **表**：`smart_home_device`，由 JPA `ddl-auto: update` 自动创建，存储设备连接信息、控制信息与基本信息。

| 字段 | 说明 |
|------|------|
| id | 主键 |
| device_id | 设备唯一标识，用于下发指令 |
| device_name | 设备显示名，如「客厅主灯」 |
| room | 房间名，如「客厅」「卧室」，供语音解析匹配 |
| room_id | 房间标识，如 living_room |
| device_type | 设备类型：light / socket 等 |
| connection_url | 连接信息：控制接口 base URL，如 http://192.168.1.100:8080 |
| control_method | 控制方式：GET / POST |
| control_on | 开指令：GET 时为路径，POST 时为 JSON，如 {"action":"on"} |
| control_off | 关指令 |
| status | 当前状态：on / off / unknown |
| enabled | 是否启用 |

## 二、流程：用户说「开关灯」→ 大模型解析 → 查库 → 发指令

1. 用户说「开灯」「关客厅灯」等，ASR 转文字。
2. 大模型结合 RAG 与系统提示，生成回复；若判断为开关灯意图，在回复末尾**单独一行**输出：  
   `[DEVICE_CTL] room=客厅 action=on` 或 `action=off`，未指定房间则 `room=all`。
3. 管道解析该行：若存在，则**查库**（按 room 查 `smart_home_device`），向匹配设备**发送控制请求**（GET/POST 到 `connection_url` + control_on/control_off）。
4. 该行从回复中移除，剩余内容作为 TTS 播报（如「好的，已打开客厅灯」）。

## 三、设备管理 API

- **列表**：`GET /api/device/list?room=客厅`  
- **详情**：`GET /api/device/{id}`  
- **新增**：`POST /api/device`，Body 为设备 JSON  
- **修改**：`PUT /api/device/{id}`  
- **删除**：`DELETE /api/device/{id}`  
- **手动控制**：`POST /api/device/control`，Body：`{"room":"客厅","action":"on"}` 或 `{"deviceId":"device_001","action":"off"}`  

## 四、添加示例设备

通过接口添加一条「客厅灯」示例（控制接口需替换为实际设备地址）：

```bash
curl -X POST http://localhost:8080/api/device -H "Content-Type: application/json" -d "{\"deviceId\":\"device_001\",\"deviceName\":\"客厅主灯\",\"room\":\"客厅\",\"roomId\":\"living_room\",\"deviceType\":\"light\",\"connectionUrl\":\"http://192.168.1.100:8080\",\"controlMethod\":\"POST\",\"controlOn\":\"{\\\"action\\\":\\\"on\\\"}\",\"controlOff\":\"{\\\"action\\\":\\\"off\\\"}\",\"enabled\":true}"
```

或 PowerShell：

```powershell
$body = @{
  deviceId       = "device_001"
  deviceName     = "客厅主灯"
  room           = "客厅"
  roomId         = "living_room"
  deviceType     = "light"
  connectionUrl  = "http://192.168.1.100:8080"
  controlMethod  = "POST"
  controlOn      = '{"action":"on"}'
  controlOff     = '{"action":"off"}'
  enabled        = $true
} | ConvertTo-Json
Invoke-RestMethod -Uri "http://localhost:8080/api/device" -Method Post -ContentType "application/json" -Body $body
```

添加后，用户说「开灯」或「关客厅灯」时，大模型会解析并输出 `[DEVICE_CTL]` 行，服务查库后向该设备发送对应开关指令。

---

## 五、将设备表信息加入知识库（RAG）

设备表（`smart_home_device`）中的连接信息、控制信息、房间与操作步骤，可同步到**向量知识库**，供大模型 RAG 检索（用户问「怎么开灯」「客厅灯怎么关」时会命中）。

- **同步接口**：`POST /api/vector/sync-from-devices`  
  - 会先删除知识库中 `metadata.source=device` 的旧文档，再为每个**已启用**设备生成一条文档。  
  - 文档内容包含：关灯/开灯指令、房间名、操作步骤、调用方法（如 `POST /api/device/control`、`deviceId` 等），格式与手动添加的智能家居文档一致。  
- **自动同步**：在设备的**新增**（`POST /api/device`）、**修改**（`PUT /api/device/{id}`）、**删除**（`DELETE /api/device/{id}`）成功后，会自动调用上述同步逻辑，无需再手动请求 `POST /api/vector/sync-from-devices`。仍可手动调用该接口做全量同步。

---

## 六、知识库仅用 MySQL（不再使用 vector-store.json）

**知识库（向量文档）** 默认仅存入 MySQL，不再使用 `vector-store.json` 文件。

- **配置**：`application.yml` 中 `voice.vector-store-type: mysql`（默认）。  
  - 所有文档的存储、查询、以及设备同步后的写入，均在 MySQL 表 `vector_document` 中完成。  
  - 若需改回文件存储，可设置 `vector-store-type: file`（并配置 `vector-store-path`）。  
- **表**：`vector_document` 字段包括 `id`、`text`、`embedding_json`（向量 JSON）、`metadata_json`、`source`、`created_at`。  
- **使用**：同一 MySQL 库内既有设备表 `smart_home_device`，也有知识库表 `vector_document`；设备增删改后的自动同步、以及手动 `POST /api/vector/sync-from-devices`，均写入并查询 MySQL 中的 `vector_document`。
